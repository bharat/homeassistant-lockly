#!/usr/bin/env bash
# Simulate a keypad unlock on one of the simulated locks.
#
# Usage:
#   scripts/simulate_unlock "Front Door"              # unlock with user 1
#   scripts/simulate_unlock "Front Door" --user 3     # unlock with user 3
#   scripts/simulate_unlock "Back Door" --user 2 --source rfid
#   scripts/simulate_unlock "Front Door" --action lock # simulate a lock instead
#
# Requires: mosquitto-clients (mosquitto_pub), simulator running.

set -euo pipefail

LOCK=""
USER=1
SOURCE="keypad"
ACTION="unlock"
MQTT_HOST="${MQTT_HOST:-localhost}"

while [[ $# -gt 0 ]]; do
    case "$1" in
        --user)    USER="$2"; shift 2 ;;
        --source)  SOURCE="$2"; shift 2 ;;
        --action)  ACTION="$2"; shift 2 ;;
        --help|-h)
            echo "Usage: scripts/simulate_unlock <lock-name> [--user N] [--source keypad|rfid|manual|rf] [--action unlock|lock]"
            echo ""
            echo "Locks: Front Door, Back Door, Garage Door"
            echo ""
            echo "Examples:"
            echo "  scripts/simulate_unlock \"Front Door\"            # user 1 keypad unlock"
            echo "  scripts/simulate_unlock \"Back Door\" --user 3    # user 3 keypad unlock"
            echo "  scripts/simulate_unlock \"Front Door\" --action lock"
            exit 0
            ;;
        *)
            if [[ -z "${LOCK}" ]]; then
                LOCK="$1"
            else
                echo "Error: unexpected argument '$1'" >&2
                exit 1
            fi
            shift
            ;;
    esac
done

if [[ -z "${LOCK}" ]]; then
    echo "Error: lock name required" >&2
    echo "Usage: scripts/simulate_unlock <lock-name> [--user N] [--source keypad|rfid|manual|rf]" >&2
    echo "Locks: Front Door, Back Door, Garage Door" >&2
    exit 1
fi

PAYLOAD=$(printf '{"simulate_unlock": {"user": %d, "source": "%s", "action": "%s"}}' "${USER}" "${SOURCE}" "${ACTION}")
TOPIC="zigbee2mqtt/${LOCK}/set"

echo "${ACTION} â†’ ${LOCK} (user=${USER}, source=${SOURCE})"
mosquitto_pub -h "${MQTT_HOST}" -t "${TOPIC}" -m "${PAYLOAD}"
