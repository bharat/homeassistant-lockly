#!/usr/bin/env bash
# Simulate a lock action (unlock, lock, etc.) on one of the simulated locks.
#
# Usage:
#   scripts/simulate_action "Front Door" unlock              # unlock with user 1
#   scripts/simulate_action "Front Door" unlock --user 3     # unlock with user 3
#   scripts/simulate_action "Back Door" lock                 # lock
#   scripts/simulate_action "Front Door" unlock --source rfid --user 2
#
# Requires: mosquitto-clients (mosquitto_pub), simulator running.

set -euo pipefail

LOCK=""
ACTION=""
USER=""
SOURCE=""
MQTT_HOST="${MQTT_HOST:-localhost}"

while [[ $# -gt 0 ]]; do
    case "$1" in
        --user)    USER="$2"; shift 2 ;;
        --source)  SOURCE="$2"; shift 2 ;;
        --help|-h)
            echo "Usage: scripts/simulate_action <lock-name> <action> [--user N] [--source keypad|rfid|manual|rf]"
            echo ""
            echo "Actions: unlock, lock, manual_lock, manual_unlock, key_lock, key_unlock,"
            echo "         auto_lock, one_touch_lock"
            echo ""
            echo "Locks: Front Door, Back Door, Garage Door"
            echo ""
            echo "Examples:"
            echo "  scripts/simulate_action \"Front Door\" unlock --user 1     # user 1 keypad unlock"
            echo "  scripts/simulate_action \"Back Door\" lock                 # anonymous lock (no user/source)"
            echo "  scripts/simulate_action \"Front Door\" lock --source rf    # RF lock (automation)"
            echo "  scripts/simulate_action \"Front Door\" manual_lock         # manual lock"
            exit 0
            ;;
        -*)
            echo "Error: unknown option '$1'" >&2
            exit 1
            ;;
        *)
            if [[ -z "${LOCK}" ]]; then
                LOCK="$1"
            elif [[ -z "${ACTION}" ]]; then
                ACTION="$1"
            else
                echo "Error: unexpected argument '$1'" >&2
                exit 1
            fi
            shift
            ;;
    esac
done

if [[ -z "${LOCK}" || -z "${ACTION}" ]]; then
    echo "Error: lock name and action required" >&2
    echo "Usage: scripts/simulate_action <lock-name> <action> [--user N] [--source keypad|rfid|manual|rf]" >&2
    echo "  e.g. scripts/simulate_action \"Front Door\" unlock --user 1" >&2
    exit 1
fi

INNER='"action": "'"${ACTION}"'"'
[[ -n "${USER}" ]]   && INNER+=', "user": '"${USER}"
[[ -n "${SOURCE}" ]] && INNER+=', "source": "'"${SOURCE}"'"'
PAYLOAD='{"simulate_action": {'"${INNER}"'}}'
TOPIC="zigbee2mqtt/${LOCK}/set"

DESC="${ACTION} â†’ ${LOCK}"
[[ -n "${USER}" ]]   && DESC+=" (user=${USER})"
[[ -n "${SOURCE}" ]] && DESC+=" (source=${SOURCE})"
echo "${DESC}"
mosquitto_pub -h "${MQTT_HOST}" -t "${TOPIC}" -m "${PAYLOAD}"
