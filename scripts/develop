#!/usr/bin/env bash
# Start a Home Assistant development environment with MQTT and simulated locks.
#
# Usage:
#   ./scripts/develop                # Start Mosquitto + simulator + HA
#   ./scripts/develop --no-sim       # Start Mosquitto + HA (no simulator)
#   ./scripts/develop --mqtt-verbose # Full MQTT protocol tracing
#
# All processes run in the foreground via concurrently and stop together on Ctrl+C.
# HA is available at http://localhost:8123

set -euo pipefail
cd "$(dirname "$0")/.."

SCRIPT_DIR="$(pwd)"
CONFIG_DIR="${SCRIPT_DIR}/config"

export PYTHONPATH="${SCRIPT_DIR}:${PYTHONPATH:-}"

echo "=== Lockly Development Server ==="
echo "Config:  ${CONFIG_DIR}"
echo "Integration: custom_components/lockly"
echo ""

SIM="--sim"
MQTT_CONF="${CONFIG_DIR}/mosquitto.conf"

for arg in "$@"; do
    case "${arg}" in
        --no-sim)       SIM="" ;;
        --mqtt-verbose) MQTT_CONF="${CONFIG_DIR}/mosquitto-verbose.conf" ;;
    esac
done

COMMANDS=(
    "mosquitto -c ${MQTT_CONF}"
    "hass --config ${CONFIG_DIR} --debug"
)
NAMES="mqtt,hass"
COLORS="blue,magenta"

if [ -n "${SIM}" ]; then
    COMMANDS+=("python3 scripts/simulate_devices.py")
    NAMES="${NAMES},sim"
    COLORS="${COLORS},green"
fi

concurrently \
    --kill-others \
    --names "${NAMES}" \
    --prefix-colors "${COLORS}" \
    --prefix "[{name}]" \
    "${COMMANDS[@]}"
